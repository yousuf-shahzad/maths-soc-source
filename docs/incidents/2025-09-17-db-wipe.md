# Incident: Production Database Wiped by Test Run

ID: 2025-09-17-db-wipe  
Date Detected: 2025-09-17T14:15Z  
Severity: SEV1 (Critical)
Status: Closed (2025-09-17T18:40Z)

## Summary

Test suite executed against the live production database. The teardown fixture dropped all tables (`db.drop_all()`). Application subsequently recreated an empty schema, resulting in full data loss.

## Impact

- All user data (accounts, submissions, leaderboard) lost.
- Users faced empty UI / login anomalies.
- Backups unavailable (no restorable snapshot).

## Timeline (UTC)

| Time | Event |
|------|-------|
| 20:21 | Pytest invoked on prod host |
| 20:21 | `db.drop_all()` executed (inferred) |
| 20:08 | Website crashes as a result of database loss (Internal Server Error) |
| 20:15 | Investigation yields that data has been gone |
| 20:22 | Attempt to restore from backup |
| 21:05 | Backup restoration attempt failed |
| 21:20 | Recreate database schema |
| 21:40 | Site operational again, data completely lost |
| 23:40 | Root error identified (test harness) |
| 23:50 | Review of test environment isolation |
| 00:00 | Hardening changes drafted |
| 00:40 | Hardening changes implemented |
| 01:00 | Incident declared resolved |

## Root Cause

No environment guard prevented tests from connecting to production DB. Same privileged credentials reused across environments allowed DDL (DROP).

## Contributing Factors

- Shared DB user with broad privileges
- Absence of backup validation
- Lack of “are you sure?” guard in test teardown
- No DDL anomaly monitoring

## Mitigation

1. Stopped app writes
2. Confirmed schema recreation
3. Credential rotation initiated
4. Drafted guard code for tests & init script

## Follow-up Actions

| ID | Action | Owner | Due | Status |
|----|--------|-------|-----|--------|
| A1 | Add environment guard to tests | yousuf | 2025-09-19 | open |
| A2 | Implement daily + verified backups | yousuf | 2025-09-24 | open |
| A3 | Rebuild minimal seed data | yousuf | 2025-09-18 | open |

## Lessons Learned

- Fast detection depends on anomaly alerts; currently absent.
- Test isolation must be enforced by code and permissions, not habit.

## References

- GitHub Issue: (link once created)
- Commit hardening PR: (link)
- Search (today’s commits): internal
