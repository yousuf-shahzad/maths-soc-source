{% extends "base.html" %}
{% block title %}Summer Competition 2025 Leaderboard{% endblock %}

{% block content %}
<div class="container">
    <!-- Leaderboard Header -->
    <div class="summer-hero">
        <h1>üèÜ Summer Competition 2025 Leaderboard</h1>
        <p>See how you rank against competitors from across the region!</p>
    </div>

    <div class="alert alert-info" style="margin-bottom: 1rem;">
        <strong>Note:</strong> This leaderboard is for the <b>Summer Competition 2025</b> only.<br>
        Looking for the regular UCGS weekly challenges leaderboard? 
        <a href="{{ url_for('main.leaderboard') }}" style="color: #007bff; font-weight: bold;">Click here</a>
    </div>

    <!-- Competition Statistics -->
    <div class="stats-grid">
        <div class="stats-card ks3-stats">
            <h3>KS3 Participants</h3>
            <p>{{ stats.ks3_participants or 0 }}</p>
        </div>
        <div class="stats-card ks4-stats">
            <h3>KS4 Participants</h3>
            <p>{{ stats.ks4_participants or 0 }}</p>
        </div>
        <div class="stats-card ks5-stats">
            <h3>KS5 Participants</h3>
            <p>{{ stats.ks5_participants or 0 }}</p>
        </div>
        <div class="stats-card points-stats">
            <h3>Points Awarded</h3>
            <p>{{ stats.total_points_awarded or 0 }}</p>
        </div>
        <div class="stats-card challenges-stats">
            <h3>Active Challenges</h3>
            <p>{{ stats.active_challenges or 0 }}</p>
        </div>
        <div class="stats-card submissions-stats">
            <h3>Total Schools</h3>
            <p>{{ stats.total_schools or 0 }}</p>
        </div>
    </div>

    <!-- Leaderboard Tabs -->
    <div class="leaderboard-tabs">
        <div class="tab-buttons">
            <button onclick="showTab('ks3')" id="ks3-tab" class="tab-button active">
                üéì Key Stage 3
            </button>
            <button onclick="showTab('ks4')" id="ks4-tab" class="tab-button">
                üìê Key Stage 4
            </button>
            <button onclick="showTab('ks5')" id="ks5-tab" class="tab-button">
                üéØ Key Stage 5
            </button>
            <button onclick="showTab('schools')" id="schools-tab" class="tab-button">
                üè´ School Rankings
            </button>
            <button onclick="showTab('activity')" id="activity-tab" class="tab-button">
                ‚ö° Recent Activity
            </button>
        </div>

        <!-- Key Stage 3 Leaderboard -->
        <div id="ks3-content" class="tab-content">
            <h2 class="tab-title ks3-title">ü•á Key Stage 3 Leaders (Years 7-8)</h2>
            {% if ks3_leaders %}
                <div class="leaderboard-table">
                    {% for entry in ks3_leaders %}
                        <div class="leaderboard-row {% if loop.index <= 3 %}podium-position{% endif %}">
                            <div class="rank">
                                {% if loop.index == 1 %}ü•á
                                {% elif loop.index == 2 %}ü•à
                                {% elif loop.index == 3 %}ü•â
                                {% else %}{{ loop.index }}
                                {% endif %}
                            </div>
                            <div class="user-info">
                                <div class="user-name">{{ entry.user.full_name }}</div>
                                <div class="user-details">
                                    {{ entry.school.name }} ‚Ä¢ Year {{ entry.user.year }}
                                </div>
                            </div>
                            <div class="score ks3-score">
                                {{ entry.score }} pts
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <!-- KS3 School Rankings -->
                <h3>üè´ Top KS3 Schools</h3>
                {% if ks3_school_leaders %}
                    <div class="school-leaderboard">
                        {% for school in ks3_school_leaders %}
                            <div class="school-row">
                                <div class="rank">
                                    {{ loop.index }}
                                </div>
                                <div class="school-info">
                                    <div>{{ school.name }}</div>
                                    <div>
                                        {{ school.participant_count }} participants ‚Ä¢ Avg: {{ "%.1f"|format(school.average_score) }} pts
                                    </div>
                                </div>
                                <div class="total-score">{{ school.total_score }} pts</div>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% else %}
                <div class="no-participants">
                    <div class="no-participants-icon">üéì</div>
                    <p>No KS3 participants yet. Be the first to join the competition!</p>
                    {% if current_user.is_authenticated and current_user.is_competition_participant %}
                        <a href="{{ url_for('main.challenges') }}" class="button">Start Solving Challenges</a>
                    {% endif %}
                </div>
            {% endif %}
        </div>

        <!-- Key Stage 4 Leaderboard -->
        <div id="ks4-content" class="tab-content" style="display: none;">
            <h2 class="tab-title ks4-title">ü•á Key Stage 4 Leaders (Years 9-11)</h2>
            {% if ks4_leaders %}
                <div class="leaderboard-table">
                    {% for entry in ks4_leaders %}
                        <div class="leaderboard-row {% if loop.index <= 3 %}podium-position{% endif %}">
                            <div class="rank">
                                {% if loop.index == 1 %}ü•á
                                {% elif loop.index == 2 %}ü•à
                                {% elif loop.index == 3 %}ü•â
                                {% else %}{{ loop.index }}
                                {% endif %}
                            </div>
                            <div class="user-info">
                                <div class="user-name">{{ entry.user.full_name }}</div>
                                <div class="user-details">
                                    {{ entry.school.name }} ‚Ä¢ Year {{ entry.user.year }}
                                </div>
                            </div>
                            <div class="score ks4-score">
                                {{ entry.score }} pts
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <!-- KS4 School Rankings -->
                <h3>üè´ Top KS4 Schools</h3>
                {% if ks4_school_leaders %}
                    <div class="school-leaderboard">
                        {% for school in ks4_school_leaders %}
                            <div class="school-row school-row-ks4 loop-{{ loop.index }}">
                                <div class="rank rank-ks4 loop-{{ loop.index }}">
                                    {{ loop.index }}
                                </div>
                                <div class="school-info">
                                    <div>{{ school.name }}</div>
                                    <div>
                                        {{ school.participant_count }} participants ‚Ä¢ Avg: {{ "%.1f"|format(school.average_score) }} pts
                                    </div>
                                </div>
                                <div class="total-score score-ks4">{{ school.total_score }} pts</div>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% else %}
                <p>No KS4 participants yet. Be the first to join the competition!</p>
            {% endif %}
        </div>

        <!-- Key Stage 5 Leaderboard -->
       <div id="ks5-content" class="tab-content" style="display: none;">
            <h2 class="tab-title ks5-title">ü•á Key Stage 5 Leaders (Years 12-13)</h2>
            {% if ks5_leaders %}
                <div class="leaderboard-table">
                    {% for entry in ks5_leaders %}
                        <div class="leaderboard-row {% if loop.index <= 3 %}podium-position{% endif %}">
                            <div class="rank">
                                {% if loop.index == 1 %}ü•á
                                {% elif loop.index == 2 %}ü•à
                                {% elif loop.index == 3 %}ü•â
                                {% else %}{{ loop.index }}
                                {% endif %}
                            </div>
                            <div class="user-info">
                                <div class="user-name">{{ entry.user.full_name }}</div>
                                <div class="user-details">
                                    {{ entry.school.name }} ‚Ä¢ Year {{ entry.user.year }}
                                </div>
                            </div>
                            <div class="score ks5-score">
                                {{ entry.score }} pts
                            </div>
                        </div>
                    {% endfor %}
               {% endif %}
                </div>
        </div>

        <!-- Combined School Rankings -->
        <div id="schools-content" class="tab-content">
            <!-- KS3 Schools -->
            <div>
                <h3>üéì Key Stage 3 Schools</h3>
                {% if ks3_school_leaders %}
                    <div class="school-leaderboard">
                        {% for school in ks3_school_leaders %}
                            <div class="school-row school-row-ks3 loop-{{ loop.index }}">
                                <div class="rank rank-ks3 loop-{{ loop.index }}">
                                    {{ loop.index }}
                                </div>
                                <div class="school-info">
                                    <div>{{ school.name }}</div>
                                    <div>
                                        {{ school.participant_count }} participants ‚Ä¢ Avg: {{ "%.1f"|format(school.average_score) }} pts
                                    </div>
                                </div>
                                <div class="total-score score-ks3">{{ school.total_score }} pts</div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p>No KS3 school data available yet.</p>
                {% endif %}
            </div>
            
            <!-- KS4 Schools -->
            <div>
                <h3>üìê Key Stage 4 Schools</h3>
                {% if ks4_school_leaders %}
                    <div class="school-leaderboard">
                        {% for school in ks4_school_leaders %}
                            <div class="school-row school-row-ks4 loop-{{ loop.index }}">
                                <div class="rank rank-ks4 loop-{{ loop.index }}">
                                    {{ loop.index }}
                                </div>
                                <div class="school-info">
                                    <div>{{ school.name }}</div>
                                    <div>
                                        {{ school.participant_count }} participants ‚Ä¢ Avg: {{ "%.1f"|format(school.average_score) }} pts
                                    </div>
                                </div>
                                <div class="total-score score-ks4">{{ school.total_score }} pts</div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p>No KS4 school data available yet.</p>
                {% endif %}
            </div>
            
            <!-- KS5 Schools -->
            <div>
                <h3>üéØ Key Stage 5 Schools</h3>
                {% if ks5_school_leaders %}
                    <div class="school-leaderboard">
                        {% for school in ks5_school_leaders %}
                            <div class="school-row school-row-ks5 loop-{{ loop.index }}">
                                <div class="rank rank-ks5 loop-{{ loop.index }}">
                                    {{ loop.index }}
                                </div>
                                <div class="school-info">
                                    <div>{{ school.name }}</div>
                                    <div>
                                        {{ school.participant_count }} participants ‚Ä¢ Avg: {{ "%.1f"|format(school.average_score) }} pts
                                    </div>
                                </div>
                                <div class="total-score score-ks5">{{ school.total_score }} pts</div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p>No KS5 school data available yet.</p>
                {% endif %}
            </div>
        </div>

        <!-- Recent Activity -->
        <div id="activity-content" class="tab-content" style="display: none;">
            <h2 class="tab-title activity-title">‚ö° Recent Activity</h2>
            {% if recent_activity %}
                <div class="activity-feed">
                    {% for submission in recent_activity %}
                        <div class="activity-item">
                            <div class="activity-icon">‚úÖ</div>
                            <div class="activity-info">
                                <div class="activity-title">{{ submission.user.full_name }}</div>
                                <div class="activity-details">
                                    Solved "{{ submission.challenge.title }}" ‚Ä¢ {{ submission.school.name }}
                                </div>
                                <div class="activity-time">
                                    {{ submission.submitted_at.strftime('%B %d, %Y at %I:%M %p') }}
                                </div>
                            </div>
                            <div class="activity-points">
                                +{{ submission.points_awarded }} pts
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="no-participants">
                    <div class="no-participants-icon">‚ö°</div>
                    <p>No recent activity to display.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Call to Action -->
    <div class="cta-section">
        <h2>Ready to Join the Summer Competition?</h2>
        <p>Start solving challenges and climb the leaderboard today!</p>
        <div class="cta-buttons">
            {% if current_user.is_anonymous %}
                <a href="{{ url_for('auth.summer_register') }}" class="cta-button primary">
                    Register Now
                </a>
                <a href="{{ url_for('auth.summer_login') }}" class="cta-button secondary">
                    Login
                </a>
            {% else %}
                <a href="{{ url_for('main.challenges') }}" class="cta-button primary">
                    View Challenges
                </a>
                {% if current_user.is_competition_participant %}
                    <a href="{{ url_for('profile.profile') }}" class="cta-button secondary">
                        My Profile
                    </a>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>

<script>
function showTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = 'none';
    });
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(tabName + '-content').style.display = 'block';
    
    // Activate selected tab button
    document.getElementById(tabName + '-tab').classList.add('active');
}

// Auto-refresh leaderboard every 60 seconds
setInterval(() => {
    if (document.hidden) return; // Don't refresh if tab is hidden
    location.reload();
}, 60000);
</script>
{% endblock %}
