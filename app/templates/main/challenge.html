{% extends "base.html" %}
{% block content %}
    <main>
        <div class="challenge-container">
            <article>
                <h1 class="challenge-title">{{ challenge.title }}</h1>
                
                <div class="challenge-meta">
                    <p>Posted on: {{ challenge.date_posted.strftime('%d/%m/%Y') }}</p>
                    <p>Key Stage: {{ challenge.key_stage.upper() }}</p>
                </div>
                
                <div class="challenge-content">
                    {{ challenge.content | safe }}
                </div>
                
                {% if challenge.file_url %}
                <div class="challenge-image">
                    <img src="{{ url_for('admin.uploaded_files', id=challenge.id) }}" 
                         alt="Challenge Image" 
                         class="responsive-image">
                </div>
                {% endif %}
                
                <div class="answer-submission">
                    <h2>Submit Your Answer</h2>
                    <form method="POST" class="answer-form">
                        {{ form.hidden_tag() }}
                        
                        <div class="form-group">
                            {{ form.answer.label(class="form-label") }}
                            <div class="pdf-viewer">
                                <math-field 
                                    id="formula"
                                    class="form-control"
                                    style="font-size: 1.5rem; padding: 1rem;">{{ form.answer.data or '' }}</math-field>
                            </div>
                            {{ form.answer(id='hidden-answer', style="display: none;") }}
                            {% for error in form.answer.errors %}
                                <span class="error-message">{{ error }}</span>
                            {% endfor %}
                        </div>
                        
                        <div class="challenge-actions">
                            {{ form.submit(class="button") }}
                        </div>
                    </form>
                </div>
            </article>
        </div>
    </main>

    <script defer src="//unpkg.com/mathlive"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const formulaField = document.getElementById('formula');
            const hiddenInput = document.getElementById('hidden-answer');

            // Initialize MathLive field with any existing value
            if (hiddenInput.value) {
                formulaField.value = hiddenInput.value;
            }

            // Update hidden input whenever math field changes
            formulaField.addEventListener('input', (evt) => {
                hiddenInput.value = formulaField.value;
            });

            // Ensure hidden input is updated before form submission
            document.querySelector('.answer-form').addEventListener('submit', function(e) {
                hiddenInput.value = formulaField.value;
            });
        });
    </script>
{% endblock %}