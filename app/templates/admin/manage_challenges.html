{% extends "base.html" %}

{% block content %}
<div class="admin-dashboard">
    <div class="page-header">
        <h1>Manage Challenges</h1>
    </div>

    <a href="{{ url_for('admin.create_challenge') }}" class="button">Create New Challenge</a>

    <div class="page-section">
    <!-- Unreleased Challenges Section -->
    {% if unreleased_challenges %}
        <section>
            <h2>📅 Unreleased Challenges</h2>
            <div class="challenge-grid">
                {% for challenge in unreleased_challenges %}
            <div class="challenge-card">
                <h2>{{ challenge.title }}</h2>
                <div class="challenge-meta">
                    <span class="challenge-date"><strong>Posted:</strong> {{ challenge.date_posted.strftime('%Y-%m-%d') }}</span><br>
                    <span class="challenge-released"><strong>Release On:</strong> {{ challenge.release_at.strftime('%Y-%m-%d %H:%M') if challenge.release_at else 'Immediate' }}</span><br>
                    <span class="challenge-lock"><strong>Auto-lock after:</strong> {{ challenge.lock_after_hours if challenge.lock_after_hours else 'No Limit' }} </span>
                </div>

                <div class="challenge-badge unreleased">
                    <span class="status-icon">🔒</span>
                    <span class="badge-text">Unreleased</span>
                </div>

                                <!-- Lock Status Display -->
                {% if challenge.is_manually_locked or challenge.lock_after_hours %}
                    <div class="challenge-badge locked">
                        <span class="status-icon">🔒</span>
                        {% if challenge.lock_after_hours %}
                            <span>Time Expired</span>
                        {% else %}
                            <span>Manually Locked On Release</span>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="challenge-badge unlocked">
                        <span class="status-icon">🔓</span>
                        <span>Will Open On Release</span>
                    </div>
                {% endif %}

                {% if challenge.file_url %}
                <div class="image-preview">
                    <img src="{{ url_for('admin.uploaded_files', id=challenge.id) }}" alt="{{ challenge.title }}" class="challenge-image">
                </div>
                {% endif %}
                
                <div>
                    <a href="{{ url_for('main.challenge', challenge_id=challenge.id) }}" 
                       class="action-btn view-btn">
                        <span class="button-icon">👁️</span>
                    </a>
                    <a href="{{ url_for('admin.edit_challenge', challenge_id=challenge.id) }}" 
                       class="action-btn edit-btn">
                        <span class="button-icon">✏️</span>
                    </a>
                    
                    <form class="form-btn" method="POST" action="{{ url_for('admin.toggle_challenge_lock', challenge_id=challenge.id) }}">
                        <button type="submit" class="action-btn reset-btn" 
                                data-action="{{ 'unlock' if challenge.is_manually_locked else 'lock' }}"
                                onclick="return confirmToggleLock(this);">
                            <span class="button-icon">{{ '🔓' if challenge.is_manually_locked else '🔒' }}</span>
                        </button>
                    </form>

                    <button class="action-btn delete-btn" 
                            data-challenge-id="{{ challenge.id }}"
                            onclick="confirmDelete(this)">
                        <span class="button-icon">🗑️</span>
                    </button>
                </div>
            </div>
            {% endfor %}
        </section>
    {% endif %}

    <!-- Released Challenges Section -->
    <section>
        <h2>✅ Released Challenges</h2>
        <div class="challenges-grid">
            {% for challenge in released_challenges %}
            <div class="challenge-card">
                <h2>{{ challenge.title }}</h2>
                <div class="challenge-meta">
                    <span class="challenge-date"><strong>Posted:</strong> {{ challenge.date_posted.strftime('%Y-%m-%d') }}</span><br>
                    <span class="challenge-released"><strong>Released:</strong> {{ challenge.release_at.strftime('%Y-%m-%d %H:%M') if challenge.release_at else 'Immediate' }}</span><br>
                    <span class="challenge-lock"><strong>Auto-lock after:</strong> {{ challenge.lock_after_hours if challenge.lock_after_hours else 'No Limit' }} </span>
                </div>
                
                <!-- Lock Status Display -->
                {% if challenge.is_manually_locked or challenge.lock_after_hours %}
                    <div class="challenge-badge locked">
                        <span class="status-icon">🔒</span>
                        {% if challenge.lock_after_hours %}
                            <span>Time Expired</span>
                        {% else %}
                            <span>Manually Locked</span>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="challenge-badge unlocked">
                        <span class="status-icon">🔓</span>
                        <span>Open</span>
                    </div>
                {% endif %}

                {% if challenge.file_url %}
                <div class="image-preview">
                    <img src="{{ url_for('admin.uploaded_files', id=challenge.id) }}" alt="{{ challenge.title }}" class="challenge-image">
                </div>
                {% endif %}
                
                <div>
                    <a href="{{ url_for('main.challenge', challenge_id=challenge.id) }}" 
                       class="action-btn view-btn">
                        <span class="button-icon">👁️</span>
                    </a>
                    <a href="{{ url_for('admin.edit_challenge', challenge_id=challenge.id) }}" 
                       class="action-btn edit-btn">
                        <span class="button-icon">✏️</span>
                    </a>
                    
                    <form class="form-btn" method="POST" action="{{ url_for('admin.toggle_challenge_lock', challenge_id=challenge.id) }}">
                        <button type="submit" class="action-btn reset-btn" 
                                data-action="{{ 'unlock' if challenge.is_manually_locked else 'lock' }}"
                                onclick="return confirmToggleLock(this);">
                            <span class="button-icon">{{ '🔓' if challenge.is_manually_locked else '🔒' }}</span>
                        </button>
                    </form>

                    <button class="action-btn delete-btn" 
                            data-challenge-id="{{ challenge.id }}"
                            onclick="confirmDelete(this)">
                        <span class="button-icon">🗑️</span>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
</div>

<script>
    function confirmDelete(button) {
        const challengeId = button.getAttribute('data-challenge-id');
        if (confirm("Are you sure you want to delete this challenge?")) {
            window.location.href = `{{ url_for('admin.delete_challenge', challenge_id=0) }}`.replace('0', challengeId);
        }
    }

    function confirmToggleLock(button) {
        const action = button.getAttribute('data-action');
        const message = action === 'lock' 
            ? "Are you sure you want to lock this challenge? Students will no longer be able to submit answers."
            : "Are you sure you want to unlock this challenge? Students will be able to submit answers again.";
        
        return confirm(message);
    }
</script>

{% endblock %}