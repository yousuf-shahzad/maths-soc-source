{% extends "base.html" %}
{% block title %}Manage Users - Summer Competition 2025{% endblock %}
{% block content %}
<div class="container">
    <!-- Admin Header -->
    <div class="user-management-header">
        <h1>👥 User Management</h1>
        <p>Manage student and admin accounts for Summer Competition 2025</p>
    </div>

    <!-- Stats Dashboard -->
    <div class="user-stats-grid">
        <div class="stat-card total-users">
            <h3>{{ total_users }}</h3>
            <p>Total Users</p>
        </div>
        <div class="stat-card admin-users">
            <h3>{{ admin_users }}</h3>
            <p>Admin Users</p>
        </div>
        <div class="stat-card competition-users">
            <h3>{{ competition_users }}</h3>
            <p>Competition Users</p>
        </div>
        <div class="stat-card regular-users">
            <h3>{{ regular_users }}</h3>
            <p>Regular Users</p>
        </div>
    </div>

    <!-- Search and Filter Controls -->
    <div class="user-controls-panel">
        <form method="GET" id="userFiltersForm" class="user-filters-form">
            <div class="filter-row">
                <div class="search-group">
                    <input type="text" 
                           name="search" 
                           value="{{ current_filters.search }}" 
                           placeholder="Search by name, class, or ID..." 
                           class="search-input"
                           id="searchInput">
                    <button type="submit" class="search-btn">🔍 Search</button>
                </div>
                
                <div class="filter-group">
                    <select name="key_stage" class="filter-select">
                        <option value="">All Key Stages</option>
                        {% for ks in available_key_stages %}
                            <option value="{{ ks }}" {% if current_filters.key_stage == ks %}selected{% endif %}>{{ ks }}</option>
                        {% endfor %}
                    </select>
                    
                    <select name="year" class="filter-select">
                        <option value="">All Years</option>
                        {% for year in available_years %}
                            <option value="{{ year }}" {% if current_filters.year == year|string %}selected{% endif %}>Year {{ year }}</option>
                        {% endfor %}
                    </select>
                    
                    <select name="user_type" class="filter-select">
                        <option value="">All Types</option>
                        <option value="competition" {% if current_filters.user_type == 'competition' %}selected{% endif %}>Competition</option>
                        <option value="regular" {% if current_filters.user_type == 'regular' %}selected{% endif %}>Regular</option>
                    </select>
                    
                    <select name="admin_status" class="filter-select">
                        <option value="">All Status</option>
                        <option value="admin" {% if current_filters.admin_status == 'admin' %}selected{% endif %}>Admin</option>
                        <option value="user" {% if current_filters.admin_status == 'user' %}selected{% endif %}>User</option>
                    </select>
                    
                    <select name="per_page" class="filter-select">
                        <option value="25" {% if current_filters.per_page == 25 %}selected{% endif %}>25 per page</option>
                        <option value="50" {% if current_filters.per_page == 50 %}selected{% endif %}>50 per page</option>
                        <option value="100" {% if current_filters.per_page == 100 %}selected{% endif %}>100 per page</option>
                    </select>
                </div>
                
                <div class="action-group">
                    <button type="submit" class="filter-btn">Apply Filters</button>
                    <a href="{{ url_for('admin.manage_users') }}" class="clear-btn">Clear All</a>
                    <a href="{{ url_for('admin.create_user') }}" class="create-user-btn">➕ Create New User</a>
                </div>
            </div>
        </form>
        
        <!-- Bulk Actions -->
        <div class="bulk-actions-panel" id="bulkActionsPanel" style="display: none;">
            <div class="bulk-info">
                <span id="selectedCount">0</span> users selected
            </div>
            <div class="bulk-buttons">
                <button onclick="performBulkAction('promote_admin')" class="bulk-btn admin-btn">👑 Make Admin</button>
                <button onclick="performBulkAction('demote_admin')" class="bulk-btn demote-btn">👤 Remove Admin</button>
                <button onclick="performBulkAction('mark_competition')" class="bulk-btn competition-btn">🏆 Mark Competition</button>
                <button onclick="performBulkAction('unmark_competition')" class="bulk-btn regular-btn">🎓 Mark Regular</button>
                <button onclick="performBulkAction('delete')" class="bulk-btn delete-btn">🗑️ Delete Selected</button>
                <button onclick="clearSelection()" class="bulk-btn cancel-btn">✖️ Cancel</button>
            </div>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Users Table -->
    <div class="users-table-container">
        <div class="table-header">
            <h2>Users ({{ pagination.total }} total)</h2>
            <div class="table-controls">
                <button onclick="selectAll()" class="select-all-btn">Select All</button>
                <button onclick="clearSelection()" class="clear-selection-btn">Clear Selection</button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="users-table">
                <thead>
                    <tr>
                        <th class="select-col">
                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleAllSelection(this)">
                        </th>
                        <th>👤 Name</th>
                        <th>#️⃣ ID</th>
                        <th>📚 Year</th>
                        <th>🔢 Class/School</th>
                        <th>📊 Key Stage</th>
                        <th>🏆 Type</th>
                        <th>⭐ Status</th>
                        <th>📅 Joined</th>
                        <th>⚙️ Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                        <tr class="user-row" data-user-id="{{ user.id }}">
                            <td class="select-col">
                                <input type="checkbox" class="user-checkbox" value="{{ user.id }}" onchange="updateBulkActions()">
                            </td>
                            <td class="user-name">
                                <div class="user-info">
                                    <span class="user-icon">
                                        {% if user.is_admin %}👑{% elif user.is_competition_participant %}🏆{% else %}🎓{% endif %}
                                    </span>
                                    <span class="name">{{ user.full_name }}</span>
                                </div>
                            </td>
                            <td class="user-id">{{ user.id }}</td>
                            <td class="user-year">
                                <span class="year-badge">Year {{ user.year }}</span>
                            </td>
                            <td class="user-class">
                                {% if user.is_competition_participant and user.school %}
                                    <span class="school-badge">🏫 {{ user.school.name }}</span>
                                {% else %}
                                    {{ user.maths_class or '—' }}
                                {% endif %}
                            </td>
                            <td class="user-key-stage">
                                <span class="key-stage-badge ks-{{ user.key_stage.lower() if user.key_stage }}">
                                    {{ user.key_stage }}
                                </span>
                            </td>
                            <td class="user-type">
                                {% if user.is_competition_participant %}
                                    <span class="type-badge competition">🏆 Summer</span>
                                {% else %}
                                    <span class="type-badge regular">🎓 Regular</span>
                                {% endif %}
                            </td>
                            <td class="user-status">
                                <span class="status-badge {% if user.is_admin %}admin{% else %}user{% endif %}">
                                    {% if user.is_admin %}👑 Admin{% else %}👤 User{% endif %}
                                </span>
                            </td>
                            <td class="user-joined">
                                {{ user.date_joined.strftime('%Y-%m-%d') if user.date_joined else '—' }}
                            </td>
                            <td class="user-actions">
                                <div class="action-buttons">
                                    <a href="{{ url_for('admin.edit_user', user_id=user.id) }}" class="action-btn edit-btn" title="Edit User">✏️</a>
                                    <a href="{{ url_for('admin.toggle_admin', user_id=user.id) }}" 
                                       class="action-btn admin-btn" 
                                       title="Toggle Admin Status"
                                       onclick="return confirm('Toggle admin status for {{ user.full_name }}?');">👑</a>
                                    <a href="{{ url_for('admin.reset_password', user_id=user.id) }}" 
                                       class="action-btn reset-btn" 
                                       title="Reset Password"
                                       onclick="return confirm('Reset password for {{ user.full_name }}?');">🔑</a>
                                    {% if current_user.id != user.id %}
                                        <a href="{{ url_for('admin.delete_user', user_id=user.id) }}" 
                                           class="action-btn delete-btn" 
                                           title="Delete User"
                                           onclick="return confirm('Delete {{ user.full_name }}? This cannot be undone.');">🗑️</a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="10" class="no-users">
                                <div class="empty-state">
                                    <h3>👤 No users found</h3>
                                    <p>No users match your current filters.</p>
                                    <a href="{{ url_for('admin.create_user') }}" class="create-user-btn">Create First User</a>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if pagination.pages > 1 %}
            <div class="pagination-container">
                <div class="pagination">
                    {% if pagination.has_prev %}
                        <a href="{{ url_for('admin.manage_users', page=pagination.prev_num, **current_filters) }}" 
                           class="page-btn prev-btn">« Previous</a>
                    {% endif %}
                    
                    {% for page_num in pagination.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != pagination.page %}
                                <a href="{{ url_for('admin.manage_users', page=page_num, **current_filters) }}" 
                                   class="page-btn">{{ page_num }}</a>
                            {% else %}
                                <span class="page-btn current">{{ page_num }}</span>
                            {% endif %}
                        {% else %}
                            <span class="page-btn ellipsis">…</span>
                        {% endif %}
                    {% endfor %}
                    
                    {% if pagination.has_next %}
                        <a href="{{ url_for('admin.manage_users', page=pagination.next_num, **current_filters) }}" 
                           class="page-btn next-btn">Next »</a>
                    {% endif %}
                </div>
                
                <div class="pagination-info">
                    Showing {{ pagination.per_page * (pagination.page - 1) + 1 }}-{{ pagination.per_page * (pagination.page - 1) + users|length }} of {{ pagination.total }} users
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script>
// User selection and bulk actions
let selectedUsers = new Set();

function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.user-checkbox');
    selectedUsers.clear();
    
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            selectedUsers.add(checkbox.value);
        }
    });
    
    const bulkPanel = document.getElementById('bulkActionsPanel');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selectedUsers.size > 0) {
        bulkPanel.style.display = 'flex';
        selectedCount.textContent = selectedUsers.size;
    } else {
        bulkPanel.style.display = 'none';
    }
    
    // Update select all checkbox
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    if (selectedUsers.size === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
    } else if (selectedUsers.size === checkboxes.length) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
    } else {
        selectAllCheckbox.indeterminate = true;
    }
}

function toggleAllSelection(selectAllCheckbox) {
    const checkboxes = document.querySelectorAll('.user-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    updateBulkActions();
}

function selectAll() {
    const checkboxes = document.querySelectorAll('.user-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    updateBulkActions();
}

function clearSelection() {
    const checkboxes = document.querySelectorAll('.user-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    selectedUsers.clear();
    document.getElementById('bulkActionsPanel').style.display = 'none';
    document.getElementById('selectAllCheckbox').checked = false;
}

async function performBulkAction(action) {
    if (selectedUsers.size === 0) {
        alert('Please select users first.');
        return;
    }
    
    const actionNames = {
        'promote_admin': 'promote to admin',
        'demote_admin': 'remove admin privileges from',
        'mark_competition': 'mark as competition participants',
        'unmark_competition': 'mark as regular users',
        'delete': 'delete'
    };
    
    const actionName = actionNames[action] || action;
    if (!confirm(`Are you sure you want to ${actionName} ${selectedUsers.size} user(s)?`)) {
        return;
    }
    
    try {
        const response = await fetch('/admin/users/bulk-action', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: action,
                user_ids: Array.from(selectedUsers)
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    }
}

// Auto-submit filters on change
document.querySelectorAll('.filter-select').forEach(select => {
    select.addEventListener('change', function() {
        document.getElementById('userFiltersForm').submit();
    });
});

// Real-time search
let searchTimeout;
document.getElementById('searchInput').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        document.getElementById('userFiltersForm').submit();
    }, 500);
});
</script>
{% endblock %}